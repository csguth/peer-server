import websocket
import _thread
import time
import rel
import json
from io import StringIO

answer = '{"category":"answer","sdp":"v=0\\no=- 2959636669496007940 2 IN IP4 127.0.0.1\\ns=-\\nt=0 0\\na=group:BUNDLE 0 1 2\\na=extmap-allow-mixed\\na=msid-semantic: WMS 991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y\\nm=audio 9 UDP/TLS/RTP/SAVPF 111 63 103 104 9 0 8 106 105 13 110 112 113 126\\nc=IN IP4 0.0.0.0\\na=rtcp:9 IN IP4 0.0.0.0\\na=ice-ufrag:vgwz\\na=ice-pwd:jqejMHYVHO/fu5ogOmurmHqH\\na=ice-options:trickle\\na=fingerprint:sha-256 66:21:4F:48:03:74:30:D3:D2:85:88:C8:2A:DD:EB:62:A3:F8:03:2D:94:76:42:74:4C:38:EA:6E:A7:E7:06:31\\na=setup:actpass\\na=mid:0\\na=extmap:1 urn:ietf:params:rtp-hdrext:ssrc-audio-level\\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\\na=sendrecv\\na=msid:991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y 5ec0fa8f-1a27-4a1e-be42-f40b8951c28f\\na=rtcp-mux\\na=rtpmap:111 opus/48000/2\\na=rtcp-fb:111 transport-cc\\na=fmtp:111 minptime=10;useinbandfec=1\\na=rtpmap:63 red/48000/2\\na=fmtp:63 111/111\\na=rtpmap:103 ISAC/16000\\na=rtpmap:104 ISAC/32000\\na=rtpmap:9 G722/8000\\na=rtpmap:0 PCMU/8000\\na=rtpmap:8 PCMA/8000\\na=rtpmap:106 CN/32000\\na=rtpmap:105 CN/16000\\na=rtpmap:13 CN/8000\\na=rtpmap:110 telephone-event/48000\\na=rtpmap:112 telephone-event/32000\\na=rtpmap:113 telephone-event/16000\\na=rtpmap:126 telephone-event/8000\\na=ssrc:2984719506 cname:IHnXYgHoJ1EFatVv\\na=ssrc:2984719506 msid:991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y 5ec0fa8f-1a27-4a1e-be42-f40b8951c28f\\nm=video 9 UDP/TLS/RTP/SAVPF 96 97 102 122 127 121 125 107 108 109 124 120 39 40 45 46 98 99 100 101 123 119 114 115 116\\nc=IN IP4 0.0.0.0\\na=rtcp:9 IN IP4 0.0.0.0\\na=ice-ufrag:vgwz\\na=ice-pwd:jqejMHYVHO/fu5ogOmurmHqH\\na=ice-options:trickle\\na=fingerprint:sha-256 66:21:4F:48:03:74:30:D3:D2:85:88:C8:2A:DD:EB:62:A3:F8:03:2D:94:76:42:74:4C:38:EA:6E:A7:E7:06:31\\na=setup:actpass\\na=mid:1\\na=extmap:14 urn:ietf:params:rtp-hdrext:toffset\\na=extmap:2 http://www.webrtc.org/experiments/rtp-hdrext/abs-send-time\\na=extmap:13 urn:3gpp:video-orientation\\na=extmap:3 http://www.ietf.org/id/draft-holmer-rmcat-transport-wide-cc-extensions-01\\na=extmap:5 http://www.webrtc.org/experiments/rtp-hdrext/playout-delay\\na=extmap:6 http://www.webrtc.org/experiments/rtp-hdrext/video-content-type\\na=extmap:7 http://www.webrtc.org/experiments/rtp-hdrext/video-timing\\na=extmap:8 http://www.webrtc.org/experiments/rtp-hdrext/color-space\\na=extmap:4 urn:ietf:params:rtp-hdrext:sdes:mid\\na=extmap:10 urn:ietf:params:rtp-hdrext:sdes:rtp-stream-id\\na=extmap:11 urn:ietf:params:rtp-hdrext:sdes:repaired-rtp-stream-id\\na=sendrecv\\na=msid:991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y f5fa7dab-c4b5-4a30-b619-6af68b6776e1\\na=rtcp-mux\\na=rtcp-rsize\\na=rtpmap:96 VP8/90000\\na=rtcp-fb:96 goog-remb\\na=rtcp-fb:96 transport-cc\\na=rtcp-fb:96 ccm fir\\na=rtcp-fb:96 nack\\na=rtcp-fb:96 nack pli\\na=rtpmap:97 rtx/90000\\na=fmtp:97 apt=96\\na=rtpmap:102 H264/90000\\na=rtcp-fb:102 goog-remb\\na=rtcp-fb:102 transport-cc\\na=rtcp-fb:102 ccm fir\\na=rtcp-fb:102 nack\\na=rtcp-fb:102 nack pli\\na=fmtp:102 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42001f\\na=rtpmap:122 rtx/90000\\na=fmtp:122 apt=102\\na=rtpmap:127 H264/90000\\na=rtcp-fb:127 goog-remb\\na=rtcp-fb:127 transport-cc\\na=rtcp-fb:127 ccm fir\\na=rtcp-fb:127 nack\\na=rtcp-fb:127 nack pli\\na=fmtp:127 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42001f\\na=rtpmap:121 rtx/90000\\na=fmtp:121 apt=127\\na=rtpmap:125 H264/90000\\na=rtcp-fb:125 goog-remb\\na=rtcp-fb:125 transport-cc\\na=rtcp-fb:125 ccm fir\\na=rtcp-fb:125 nack\\na=rtcp-fb:125 nack pli\\na=fmtp:125 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=42e01f\\na=rtpmap:107 rtx/90000\\na=fmtp:107 apt=125\\na=rtpmap:108 H264/90000\\na=rtcp-fb:108 goog-remb\\na=rtcp-fb:108 transport-cc\\na=rtcp-fb:108 ccm fir\\na=rtcp-fb:108 nack\\na=rtcp-fb:108 nack pli\\na=fmtp:108 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=42e01f\\na=rtpmap:109 rtx/90000\\na=fmtp:109 apt=108\\na=rtpmap:124 H264/90000\\na=rtcp-fb:124 goog-remb\\na=rtcp-fb:124 transport-cc\\na=rtcp-fb:124 ccm fir\\na=rtcp-fb:124 nack\\na=rtcp-fb:124 nack pli\\na=fmtp:124 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=4d001f\\na=rtpmap:120 rtx/90000\\na=fmtp:120 apt=124\\na=rtpmap:39 H264/90000\\na=rtcp-fb:39 goog-remb\\na=rtcp-fb:39 transport-cc\\na=rtcp-fb:39 ccm fir\\na=rtcp-fb:39 nack\\na=rtcp-fb:39 nack pli\\na=fmtp:39 level-asymmetry-allowed=1;packetization-mode=0;profile-level-id=4d001f\\na=rtpmap:40 rtx/90000\\na=fmtp:40 apt=39\\na=rtpmap:45 AV1/90000\\na=rtcp-fb:45 goog-remb\\na=rtcp-fb:45 transport-cc\\na=rtcp-fb:45 ccm fir\\na=rtcp-fb:45 nack\\na=rtcp-fb:45 nack pli\\na=rtpmap:46 rtx/90000\\na=fmtp:46 apt=45\\na=rtpmap:98 VP9/90000\\na=rtcp-fb:98 goog-remb\\na=rtcp-fb:98 transport-cc\\na=rtcp-fb:98 ccm fir\\na=rtcp-fb:98 nack\\na=rtcp-fb:98 nack pli\\na=fmtp:98 profile-id=0\\na=rtpmap:99 rtx/90000\\na=fmtp:99 apt=98\\na=rtpmap:100 VP9/90000\\na=rtcp-fb:100 goog-remb\\na=rtcp-fb:100 transport-cc\\na=rtcp-fb:100 ccm fir\\na=rtcp-fb:100 nack\\na=rtcp-fb:100 nack pli\\na=fmtp:100 profile-id=2\\na=rtpmap:101 rtx/90000\\na=fmtp:101 apt=100\\na=rtpmap:123 H264/90000\\na=rtcp-fb:123 goog-remb\\na=rtcp-fb:123 transport-cc\\na=rtcp-fb:123 ccm fir\\na=rtcp-fb:123 nack\\na=rtcp-fb:123 nack pli\\na=fmtp:123 level-asymmetry-allowed=1;packetization-mode=1;profile-level-id=64001f\\na=rtpmap:119 rtx/90000\\na=fmtp:119 apt=123\\na=rtpmap:114 red/90000\\na=rtpmap:115 rtx/90000\\na=fmtp:115 apt=114\\na=rtpmap:116 ulpfec/90000\\na=ssrc-group:FID 3011654688 878824957\\na=ssrc:3011654688 cname:IHnXYgHoJ1EFatVv\\na=ssrc:3011654688 msid:991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y f5fa7dab-c4b5-4a30-b619-6af68b6776e1\\na=ssrc:878824957 cname:IHnXYgHoJ1EFatVv\\na=ssrc:878824957 msid:991OjvCgZ37k8cVNIXuG99RDSiITaVfB3z7Y f5fa7dab-c4b5-4a30-b619-6af68b6776e1\\nm=application 9 UDP/DTLS/SCTP webrtc-datachannel\\nc=IN IP4 0.0.0.0\\na=ice-ufrag:vgwz\\na=ice-pwd:jqejMHYVHO/fu5ogOmurmHqH\\na=ice-options:trickle\\na=fingerprint:sha-256 66:21:4F:48:03:74:30:D3:D2:85:88:C8:2A:DD:EB:62:A3:F8:03:2D:94:76:42:74:4C:38:EA:6E:A7:E7:06:31\\na=setup:actpass\\na=mid:2\\na=sctp-port:5000\\na=max-message-size:262144\\n"}'

def on_message(ws, message):
    print(json.loads(message))
    ws.send(answer)

def on_error(ws, error):
    print(error)

def on_close(ws, close_status_code, close_msg):
    print("### closed ###")

def on_open(ws):
    print("Opened connection")
    ws.send("/join main")

if __name__ == "__main__":
    websocket.enableTrace(True)
    ws = websocket.WebSocketApp("ws://192.168.178.176:8080/ws",
                              on_open=on_open,
                              on_message=on_message,
                              on_error=on_error,
                              on_close=on_close)
    ws.run_forever(dispatcher=rel, reconnect=5)  # Set dispatcher to automatic reconnection, 5 second reconnect delay if connection closed unexpectedly
    rel.signal(2, rel.abort)  # Keyboard Interrupt
    rel.dispatch()